<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Restaurant Menu</title>
  <style>
    /* Keep your existing styles */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Restaurant Menu</h1>
    </header>
    
    <div id="loading" class="loading">
      Loading menu...
    </div>
    
    <div id="last-updated" class="last-updated"></div>
    
    <div id="error" class="error-message" style="display: none;"></div>
    
    <div id="menu-container" class="menu-categories" style="display: none;"></div>
    
    <footer>
      <p>Scan the QR code again to get the latest menu updates</p>
    </footer>
  </div>

  <!-- Use aes-js instead of CryptoJS -->
  <script src="https://cdn.jsdelivr.net/npm/aes-js@3.1.2/index.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const loadingElement = document.getElementById('loading');
      const errorElement = document.getElementById('error');
      const menuContainer = document.getElementById('menu-container');
      const lastUpdatedElement = document.getElementById('last-updated');
      
      // Get query parameters
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
      
      // Convert base64 to byte array
      function base64ToBytes(base64) {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      }

      // Convert string to byte array (UTF-8)
      function stringToBytes(str) {
        const encoder = new TextEncoder();
        return encoder.encode(str);
      }

      // Convert byte array to string (UTF-8)
      function bytesToString(bytes) {
        const decoder = new TextDecoder('utf-8');
        return decoder.decode(bytes);
      }

      // Decrypt the data using aes-js
      function decryptData(encryptedData, ivBase64) {
        try {
          // Convert key, IV, and encrypted data to bytes
          const key = stringToBytes('12345678901234567890123456789012'); // 32 bytes for AES-256
          const iv = base64ToBytes(ivBase64);
          const encryptedBytes = base64ToBytes(encryptedData);

          // Decrypt using aes-js (CBC mode with PKCS7 padding)
          const aesCbc = new aesjs.ModeOfOperation.cbc(key, iv);
          const decryptedBytes = aesCbc.decrypt(encryptedBytes);

          // Remove PKCS7 padding
          const paddingLength = decryptedBytes[decryptedBytes.length - 1];
          const unpaddedBytes = decryptedBytes.slice(0, decryptedBytes.length - paddingLength);

          // Convert decrypted bytes to string
          const decryptedString = bytesToString(unpaddedBytes);
          console.log('Decrypted string (raw):', decryptedString);

          if (!decryptedString) {
            throw new Error('Decryption failed - empty output');
          }

          return JSON.parse(decryptedString);
        } catch (e) {
          console.error('Decryption error:', e);
          throw new Error('Failed to decrypt menu data. Please scan a valid QR code.');
        }
      }
      
      // Format date
      function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        try {
          const date = new Date(dateString);
          return date.toLocaleString();
        } catch (e) {
          return dateString;
        }
      }
      
      // Display the menu
      function displayMenu(menuData) {
        if (!menuData || !menuData.menu || !Array.isArray(menuData.menu)) {
          throw new Error('Invalid menu data structure');
        }
        
        const categories = {};
        menuData.menu.forEach(item => {
          const category = item.category || 'Main Menu';
          if (!categories[category]) {
            categories[category] = [];
          }
          categories[category].push(item);
        });
        
        let menuHtml = '';
        for (const [categoryName, items] of Object.entries(categories)) {
          menuHtml += `
            <div class="category">
              <div class="category-name">${categoryName}</div>
              <div class="menu-items">
                ${items.map(item => `
                  <div class="menu-item">
                    <div class="item-name">
                      <span>${item.name || 'Unnamed Item'}</span>
                      <span class="item-price">$${(item.price || 0).toFixed(2)}</span>
                    </div>
                    ${item.description ? `<div class="item-description">${item.description}</div>` : ''}
                    ${item.details ? `<div class="item-details">${item.details}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        menuContainer.innerHTML = menuHtml;
        lastUpdatedElement.textContent = `Last updated: ${formatDate(menuData.lastUpdated)}`;
        
        loadingElement.style.display = 'none';
        menuContainer.style.display = 'block';
      }
      
      // Main execution
      try {
        const encryptedData = getQueryParam('data');
        const ivBase64 = getQueryParam('iv');
        
        if (!encryptedData || !ivBase64) {
          throw new Error('Missing required parameters in URL');
        }
        
        const menuData = decryptData(encryptedData, ivBase64);
        displayMenu(menuData);
      } catch (error) {
        console.error('Error:', error);
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.textContent = error.message;
      }
    });
  </script>
</body>
</html>